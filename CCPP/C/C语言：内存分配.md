<h1 align="center">C语言：内存分配</h1>

[toc]

## **一，内存分配**

### **1，内存分配的类型：**

在C/C++中内存分为5个区，分别为**栈区、堆区、全局/静态存储区、常量存储区、代码区。**

**静态内存分配:**编译时分配。包括:全局、静态全局、静态局部三种变量。

**动态内存分配:**运行时分配。包括:栈(stack): 局部变量。堆(heap): c语言中用到的变量被动态的分配在内存中。(malloc或calloc、realloc、free函数)

### **2.变量的内存分配：**

**栈区（stack）：**指那些由编译器在需要的时候分配，不需要时自动清除的变量所在的储存区，如函数执行时，函数的形参以及函数内的局部变量分配在栈区，函数运行结束后，形参和局部变量去栈（自动释放）。栈内存分配运算内置与处理器的指令集中，效率高但是分配的内存空间有限。

**堆区（heap）：**指哪些由程序员手动分配释放的储存区，如果程序员不释放这块内存，内存将一直被占用，直到程序运行结束由系统自动收回，c语言中使用malloc，free申请和释放空间。

**静态储存区（static）：**全局变量和静态变量的储存是放在一块的，其中初始化的全局变量和静态变量在一个区域，这块空间当程序运行结束后由系统释放。

**常量储存区（const）：**常量字符串就是储存在这里的，如“ABC”字符串就储存在常量区，储存在常量区的只读不可写。const修饰的全局变量也储存在常量区，const修饰的局部变量依然在栈上。

**程序代码区：**存放源程序的二进制代码。

## **二，堆与栈的对比**

**申请方式**：栈由编译器管理，堆的分配和释放由程序员管理。

**申请大小**：栈是向低地址生长的数据结构，是一块连续的内存，能从栈中获得的内存较小，编译期间确定大小；堆是向高地址生长的数据结构，是一个不连续的储存空间，，内存获取比较灵活，也较大。

**栈与堆中的储存内容**：

栈：在函数调用时，第一个进栈的是主函数中的最后一条指令的地址，然后是函数的各个参数，在大多 数的c编译器中，参数是由右往左入栈的，然后是函数中的局部变量（静态变量是不入栈的），当本次函数调用结束后，局部变量先出栈，然后是参数，最后栈顶指针指向最开始存的地址，也就是主函数中的下一条指令，程序由该点开始运行；

堆：一般是在堆的头部用一个字节存放堆的大小，堆中的具体内容由程序员安排。

## **三，动态内存分配**

### **1.malloc函数；**

**函数原型: void \* malloc (size_ t size) ;**

**功能:**

1.开辟一块size大小的连续堆内存。

2.size表示堆 上所开辟内存的大小(字节数)。

3.函数返回值是一个指针，指向刚刚开辟的内存的首地址。

4.如果开辟内存失败， 返回一个空指针，即返回值为NULL。

5.当内存不再 使用时，应使用free ()函数将内存块释放

6.使用时 必须包含头文件<stdlib.h>或<malloc.h>

### **2.calloc函数；**

**函数原型: void \* calloc(size_ t n, size t size);**

**功能:**

1.在内存的动态存储区中分配n个长度为si ze的连续空间，

2.函数返回一个指向分配起始地址的指针;

3.如果分配不成功，返回NULL。

4.当内存不再 使用时，应使用free ()函数将内存块释放。

5.使用时 必须包含头文件<stdlib.h>或<malloc.h>

### **3.realloc函数；**

**函数原型:**

**void \* realloc(void \* mem_ address, size_ t newsize) ;**

**功能:**

**1.**为已有内存的变量重新分配新的内存大小(可大、可小) ;

**2.**先判断当前的指针是否有足够的连续空间，如果有，扩大mem_address指向的地址，并且将mem_ address返回;

**3.**如果空间不够，先按照newsize指定的大小分配空间，将原有数据从头到尾拷贝到新分配的内存区域，而后释放原来mem_address 所指内存区域(注意:原来指针是自动释放，不需要使用free),同时返回新分配的内存区域的首地址。即重新分配存储器块的地址。

**4.**如果重新分配成功则返回指向被分配内存的指针;

**5.**如果分配不成功，返回NULL。

**6.**当内存不再使用时，应使用free ()函数将内存块释放

**7.**使用时必须包含头文件<stdlib.h>或<malloc.h>

### **4.free函数。**

**函数原型: void free (void \*ptr) ; //ptr为要释放的内存指针。**

free()：释放指针变量在堆区上的内存空间，不能释放栈上的内存空间，free要与malloc(calloc、realloc)成对使用。

注意：

如果malloc（calloc、realloc） 比 free 多， 会造成内存泄漏；

如果malloc（calloc、realloc） 比 free 少，会造成二次删除， 破坏内存，导致程序崩溃。



## 来源

[C语言：内存分配 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/52125577)

